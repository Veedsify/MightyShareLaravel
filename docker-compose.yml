version: "3.8"

services:
    app:
        build:
            context: .
            dockerfile: Dockerfile

        environment:
            # Application
            - APP_NAME=${APP_NAME}
            - APP_ENV=${APP_ENV:-production}
            - APP_KEY=${APP_KEY}
            - APP_DEBUG=${APP_DEBUG:-false}
            - APP_URL=${APP_URL}
            - APP_LOCALE=${APP_LOCALE:-en}
            - APP_FALLBACK_LOCALE=${APP_FALLBACK_LOCALE:-en}
            - APP_MAINTENANCE_DRIVER=${APP_MAINTENANCE_DRIVER:-file}

            # Database
            - DB_CONNECTION=${DB_CONNECTION:-pgsql}
            - DB_HOST=${DB_HOST}
            - DB_PORT=${DB_PORT:-5432}
            - DB_DATABASE=${DB_DATABASE}
            - DB_USERNAME=${DB_USERNAME}
            - DB_PASSWORD=${DB_PASSWORD}

            # Cache
            - CACHE_STORE=${CACHE_STORE:-database}
            - CACHE_PREFIX=${CACHE_PREFIX}

            # Session
            - SESSION_DRIVER=${SESSION_DRIVER:-database}
            - SESSION_LIFETIME=${SESSION_LIFETIME:-120}
            - SESSION_DOMAIN=${SESSION_DOMAIN}
            - SESSION_SECURE_COOKIE=${SESSION_SECURE_COOKIE}

            # Queue
            - QUEUE_CONNECTION=${QUEUE_CONNECTION:-database}

            # Redis (if used)
            - REDIS_CLIENT=${REDIS_CLIENT:-phpredis}
            - REDIS_HOST=${REDIS_HOST}
            - REDIS_PASSWORD=${REDIS_PASSWORD}
            - REDIS_PORT=${REDIS_PORT:-6379}

            # Mail
            - MAIL_MAILER=${MAIL_MAILER:-log}
            - MAIL_HOST=${MAIL_HOST}
            - MAIL_PORT=${MAIL_PORT:-587}
            - MAIL_USERNAME=${MAIL_USERNAME}
            - MAIL_PASSWORD=${MAIL_PASSWORD}
            - MAIL_ENCRYPTION=${MAIL_ENCRYPTION:-tls}
            - MAIL_FROM_ADDRESS=${MAIL_FROM_ADDRESS}
            - MAIL_FROM_NAME=${MAIL_FROM_NAME}

            # Logging
            - LOG_CHANNEL=${LOG_CHANNEL:-stack}
            - LOG_LEVEL=${LOG_LEVEL:-debug}

            # Filesystem
            - FILESYSTEM_DISK=${FILESYSTEM_DISK:-local}

            # AWS (if used for S3, SES, etc.)
            - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
            - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
            - AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION}
            - AWS_BUCKET=${AWS_BUCKET}

        volumes:
            # Persistent storage for uploads and user-generated content
            - uploads:/var/www/html/storage/app/public
            - livewire_tmp:/var/www/html/storage/app/livewire-tmp

            # Laravel framework storage
            - cache:/var/www/html/storage/framework/cache
            - views:/var/www/html/storage/framework/views
            - sessions:/var/www/html/storage/framework/sessions

            # Application logs
            - logs:/var/www/html/storage/logs
        restart: unless-stopped

volumes:
    # Application data volumes - these persist across rebuilds
    uploads:
        driver: local
    livewire_tmp:
        driver: local

    # Laravel framework volumes
    cache:
        driver: local
    views:
        driver: local
    sessions:
        driver: local

    # Logs volume
    logs:
        driver: local
